<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Example</title>
    <!-- <script src="https://unpkg.com/vue@3.0.0-beta.14/dist/vue.global.js"></script> -->
    <script src="https://unpkg.com/vue@3.0.2/dist/vue.global.js"></script>
  </head>
  <body>
    <script type="text/x-template" id="child-template">
      <div>
        <h2>Child</h2>
      </div>
    </script>
    <script type="text/x-template" id="parent-template">
      <div>
        <h2>Parent</h2>
        <div><label for="">a: </label><span>{{a}}</span></div>
        <div><label for="">b: </label><span>{{b}}</span></div>
        <div><label for="">c: </label><span>{{c}}</span></div>
        <div><label for="">d: </label><span>{{d}}</span></div>
        
        <button @click="changeA">change a++</button>
        <Child ref="child" @changeBFromChild="changeBFromChild"></Child>
      </div>
    </script>
    <div id="app">
      <Parent></Parent>
    </div>
    <script>
    const Child = {
      template: '#child-template',
      name: 'Child',
      setup(props, { emit }) {
        const doSomething = () => { 
          console.log('child do something start')
          emit('changeBFromChild', Math.random()) 
          console.log('child do something end');
        };
        return {
          doSomething
        }
      }
    }
    const Parent = {
      template: '#parent-template',
      name: "Parent",
      components: {
        Child
      }, props: { },
      setup() {
        let a = Vue.ref(1)
        let b = Vue.ref(1)
        let c = Vue.computed(() => {
          console.log('c computed');
          return (a.value+b.value)
        })
        let d = Vue.computed(() => {
          console.log('d computed');
          return c.value + 1})
        const changeA = () => a.value++
        const { ctx } = Vue.getCurrentInstance()
        Vue.watch(() => a.value, () => {
          ctx.$refs.child.doSomething()
        })
        const changeBFromChild = () => b.value++
        return {
          a,
          b,
          c,
          d,
          changeA,
          changeBFromChild
        }
      }
    }
    Vue.createApp({
      components: {
        Parent
      }
    }).mount('#app')
    </script>
  </body>
</html>
